# PID file location
pid /tmp/nginx.pid;

events {}
http {
  upstream app { server 127.0.0.1:3000; }
  gzip off;

  server {
    listen 80;

    # API Key based routes (higher priority)
    location ~ ^/(?<apikey>[^/]+)/see$ {
      proxy_set_header x-anycrawl-api-key $apikey;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      rewrite ^/.*/see$ /sse break;
      proxy_pass http://app;
    }

    location ~ ^/(?<apikey>[^/]+)/mcp$ {
      proxy_set_header x-anycrawl-api-key $apikey;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      rewrite ^/.*/mcp$ /mcp break;
      proxy_pass http://app;
    }

    # Generic API Key route for other endpoints
    location ~ ^/(?<apikey>[^/]+)/(.*)$ {
      proxy_set_header x-anycrawl-api-key $apikey;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;

      rewrite ^/[^/]+/(.*)$ /$1 break;
      proxy_pass http://app;
    }

    location /see {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      rewrite ^/see$ /sse break;
      proxy_pass http://app;
    }

    # Direct header-based paths
    location /mcp {
      proxy_buffering off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_pass http://app/mcp;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /messages {
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;
      chunked_transfer_encoding off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/messages;
    }

    location /sse {
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;
      chunked_transfer_encoding off;
      proxy_read_timeout 620s;
      proxy_send_timeout 620s;
      proxy_set_header Connection "";
      proxy_set_header Accept "text/event-stream";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/sse;
    }

    location /health {
      proxy_buffering off;
      proxy_read_timeout 5s;
      proxy_send_timeout 5s;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app/health;
    }
  }
}
